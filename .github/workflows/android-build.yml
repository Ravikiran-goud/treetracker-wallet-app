name: Android Build and Distribute
on:
  push:
    branches: [main]
    paths: ['apps/native/**', '.github/workflows/android-build.yml', 'eas.json', 'google-services.json']
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: { node-version: 18 }
      - run: npm install -g yarn@1.22.22
      - run: sudo apt-get update && sudo apt-get install -y jq
      - run: yarn cache clean
      - run: rm -rf node_modules/ yarn.lock apps/native/node_modules/ apps/native/yarn.lock
      - run: yarn install
      - run: yarn global add expo-cli eas-cli
      - run: echo "$HOME/.yarn/bin" >> $GITHUB_PATH
      - name: Validate google-services.json
        run: |
          ls -l google-services.json || { echo "Error: google-services.json not found"; exit 1; }
          jq . google-services.json || { echo "Error: google-services.json is invalid"; exit 1; }
      - name: Build Android APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          eas build -p android --profile preview --non-interactive --json > build-output.json
          cat build-output.json
          jq -r '.buildDetailsPageUrl' build-output.json
        working-directory: apps/native
      - name: Download Android APK
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          mkdir -p artifacts
          BUILD_URL=$(jq -r '.buildDetailsPageUrl' build-output.json)
          echo "Build URL: $BUILD_URL"
          BUILD_ID=$(echo $BUILD_URL | grep -o '[0-9a-f-]\{36\}$')
          echo "Build ID: $BUILD_ID"
          APK_URL=$(eas build:list --platform android --buildId "$BUILD_ID" --json | jq -r '.[0].artifacts.buildUrl // empty')
          echo "APK URL: $APK_URL"
          if [ -z "$APK_URL" ]; then echo "Error: No APK URL found"; exit 1; fi
          curl -L -o artifacts/treetracker-wallet-app.apk "$APK_URL"
        working-directory: apps/native
      - name: Upload Android APK to Firebase
        run: |
          npm install -g firebase-tools
          firebase use treetracker-wallet-app --token ${{ secrets.FIREBASE_TOKEN }}
          ls -la apps/native/artifacts/
          firebase appdistribution:distribute apps/native/artifacts/treetracker-wallet-app.apk \
            --app 1:753452510092:android:0618eb392ee153f6e084a9 \
            --release-notes "Android build from commit ${{ github.sha }}" \
            --testers "brinkcorp@gmail.com"
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}