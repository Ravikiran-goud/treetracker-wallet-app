name: Android Build and Distribute
on:
  push:
    branches: [main]
    paths: ['apps/native/**']
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with: { node-version: 18 }
      - run: npm install -g yarn@1.22.22
      - run: cd apps/native && yarn install
      - run: yarn global add expo-cli eas-cli
      - run: echo "${{ secrets.GOOGLE_SERVICES_JSON }}" > google-services.json
      - run: mv google-services.json apps/native/../..
      - run: eas login --non-interactive --username ${{ secrets.EXPO_USERNAME }} --password ${{ secrets.EXPO_PASSWORD }}
      - run: cd apps/native && yarn eas build -p android --profile preview
      - name: Upload APK to Firebase App Distribution
        run: |
          npm install -g firebase-tools
          firebase use treetracker-wallet-app --token ${{ secrets.FIREBASE_TOKEN }}
          firebase appdistribution:distribute "/Users/ravikirangoudjaggari/Downloads/application-511c510a-5d27-423b-b384-93248fb1819b.apk" \
          --app 1:753452510092:android:0618eb392ee153f6e084a9 \
          --release-notes "Initial working build for testing" \
          --testers "brinkcorp@gmail.com" 
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}